---
title: "project_graphs"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(covidHubUtils)
library(tidyverse)
library(DT)
```

## Option 2: looking at the nov-dec time period from nov1 to dec31
```{r}
timezeros_novjan <- seq(from = as.Date("2020-11-01") , to = as.Date("2021-2-01"), by="days") 

truth_data_novjan <- load_truth(truth_source = "JHU", 
                         target_variable = "inc case",
                         truth_end_date = "2020-12-31", 
                         locations = c("12", "48", "25", "36", "06", "26"))

forecasts_data_novjan <- load_forecasts(models = c("COVIDhub-baseline", "CU-select", 
                                            "OliverWyman-Navigator", "LANL-GrowthRate",
                                            "IowaStateLW-STEM", "JHU_IDD-CovidSP", "UVA-Ensemble", "JHUAPL-Bucky"), 
                                 forecast_dates = timezeros_novdec,
                                 locations = c("12", "48", "25", "36", "06", "26"), 
                                 targets = paste(1:4, "wk ahead inc case"), 
                                 hub = "US")

scored_forecasts_novjan <- score_forecasts(forecasts = forecasts_data_novdec, 
                                    truth=truth_data_novdec, 
                                    return_format = "wide")

forecasts_data_unique_novjan <-  forecasts_data_novjan %>%
  mutate(sat_fcast_week = as.Date(calc_target_week_end_date(forecast_date, horizon = 0))) %>%
  group_by(model, location, sat_fcast_week, horizon, quantile) %>%
  mutate(forecast_in_wk = row_number(), 
         last_forecast_in_wk = forecast_in_wk == max(forecast_in_wk)) %>% 
  filter(last_forecast_in_wk) %>%
  ungroup()

#min_date_novdec <- forecasts_data_novdec %>% group_by(model) %>% summarise(min_date = min(forecast_date))
#min_date_novdec
```
#Fig 1:  Case truth data (no forecasts)
```{r}
p <- plot_forecasts(forecast_data = forecasts_data_unique_novjan, 
                    truth_source = "JHU",
                    target_variable = "inc case",  
                    intervals = c(.5, .8, .95),
                    facet = .~location_name,
                    facet_scales = "free_y",
                    fill_by_model = TRUE,
                    plot = FALSE) 
p +
  scale_x_date(name=NULL, date_breaks = "1 months", date_labels = "%b") +
  theme(axis.ticks.length.x = unit(0.5, "cm"),
    axis.text.x = element_text(vjust = 7, hjust = -0.2))
```
```{r}
dates_tibble <- tibble(
  location_name = c("California", "Florida", "Massachusetts", "Michigan", "New York", "Texas"),
  date = as.Date(c('2020-12-03','2020-12-17',"2020-12-08","2020-12-07","2020-12-11","2020-11-25"))
)

truth_plot <- truth_data_novjan %>% ggplot(aes(x = target_end_date, 
             y = value, 
             color = location_name)) + 
  geom_line() +
  facet_wrap(.~location_name) + 
  theme_linedraw() 


truth_plot+ 
  geom_vline(aes(xintercept = date), dates_tibble) + labs(title = "Incident Cases Truth Data", x = "Date", y = "Incident Cases", color = "Location")
```

#Fig 2: line graph of WIS score over time  (by model)
## Note: need to figure out how to group by color
```{r}
scores_novjan <- scored_forecasts_novjan %>%
  dplyr::group_by(model, target_end_date) %>% 
  dplyr::summarise(wis = mean(wis)) 
scores_novjan %>% 
  ggplot(aes(x = target_end_date, y = wis, color = model)) + geom_line() + labs(title = "WIS Score by Model", x = "Date", y = "WIS Score", color = "Model")
```

##Fig3a: Grouped by the model group
```{r}
scored_forecasts_novjan$type <- "Neither"
scored_forecasts_novjan$type[scored_forecasts_novjan$model == "CU-select" | scored_forecasts_novjan$model == "OliverWyman-Navigator" | scored_forecasts_novjan$model == "JHUAPL-Bucky"] <- "Mobility and Social Distancing/NPIs"
scored_forecasts_novjan$type[scored_forecasts_novjan$model == "IowaStateLW-STEM" | scored_forecasts_novjan$model == "UVA-Ensemble"] <- "Only Mobility"
scored_forecasts_novjan$type[scored_forecasts_novjan$model == "JHU_IDD-CovidSP"] <- "Only Social Distancing/NPIs"

#scored_forecasts_novdec %>% select(model, type)

scores_novjan_type <- scored_forecasts_novjan %>%
  dplyr::group_by(model, type, target_end_date) %>% 
  dplyr::summarise(wis = mean(wis)) 
scores_novjan_type%>% 
  ggplot(aes(x = target_end_date, y = wis, color = type)) + geom_point() + labs(title = "WIS Score by Type of Model", x = "Date", y = "WIS Score", color = "Model Type")

#group and facet by horizon
scores_novjan_horizon <- scored_forecasts_novjan %>%
  dplyr::group_by(model, type, horizon) %>% 
  dplyr::summarise(wis = mean(wis)) 
scores_novjan_horizon %>% 
  ggplot(aes(x = horizon, y = wis, color = type)) + geom_point() + facet_wrap(.~horizon) + labs(title = "WIS Score by Type of Model and Horizon", x = "Horizon", y = "WIS Score", color = "Model Type")
```

##Fig3: Line graph faceted by location 
```{r}
scores_novjan_location <- scored_forecasts_novjan %>%
  dplyr::group_by(location, model, target_end_date) %>% 
  dplyr::summarise(wis = mean(wis)) 

dates_tibble_nums <- tibble(
  location = c("06", "12", "25", "26", "36", "48"),
  date = as.Date(c('2020-12-03','2020-12-17',"2020-12-08","2020-12-07","2020-12-11","2020-11-25"))
)

score_plots <- scores_novjan_location %>% 
  ggplot(aes(x = target_end_date, y = wis, color = model)) + geom_line() + facet_wrap(.~location) + theme_linedraw()

score_plots + 
  geom_vline(aes(xintercept = date), dates_tibble_nums) + labs(title = "WIS Scores by State and Model", x = "Date", y = "WIS Score", color = "Model") 
```

##Table1: Number of observations for each model
```{r}
num_obs <- forecasts_data_unique_novjan %>% count(model)
DT::datatable(num_obs)
```


##Table2: Average WIS scores across models 
```{r}
avg_wis <- scored_forecasts_novjan %>% group_by(model) %>% summarise(avg = mean(wis))
DT::datatable(avg_wis)
```


##Table3: Average MAE over all models (abs_error)
```{r}
avg_mae <- scored_forecasts_novjan %>% group_by(model) %>% summarise(avg = mean(abs_error))
DT::datatable(avg_mae)
```

## Heatmap
```{r}
scored_forecasts_novjan %>%
  dplyr::group_by(model, horizon) %>%
  dplyr::summarise(wis = mean(wis)) %>%
  scoringutils::score_heatmap(metric = "wis", x = "horizon")
```







