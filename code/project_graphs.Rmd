---
title: "project_graphs"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(covidHubUtils)
library(tidyverse)
library(DT)
```

## Option 2: looking at the nov-dec time period from nov1 to dec31
```{r}
#error=FALSE, warning=FALSE, include=FALSE
timezeros <- seq(from = as.Date("2020-09-01") , to = as.Date("2021-03-01"), by="days") 

truth_data <- load_truth(truth_source = "JHU", 
                         target_variable = "inc case",
                         truth_end_date = "2021-03-01", 
                         locations = c("12", "48", "25", "36", "06", "26"))

forecasts_data<- load_forecasts(models = c("COVIDhub-baseline", "CU-select", "LANL-GrowthRate",
                                            "IowaStateLW-STEM", "JHU_IDD-CovidSP", "UVA-Ensemble", "JHUAPL-Bucky"), 
                                 forecast_dates = timezeros,
                                 locations = c("12", "48", "25", "36", "06", "26"), 
                                 targets = paste(1:4, "wk ahead inc case"), 
                                 hub = "US")

scored_forecasts <- score_forecasts(forecasts = forecasts_data, 
                                    truth=truth_data, 
                                    return_format = "wide")

forecasts_data_unique <-  forecasts_data %>%
  mutate(sat_fcast_week = as.Date(calc_target_week_end_date(forecast_date, horizon = 0))) %>%
  group_by(model, location, sat_fcast_week, horizon, quantile) %>%
  mutate(forecast_in_wk = row_number(), 
         last_forecast_in_wk = forecast_in_wk == max(forecast_in_wk)) %>% 
  filter(last_forecast_in_wk) %>%
  ungroup()

#min_date_novdec <- forecasts_data_novdec %>% group_by(model) %>% summarise(min_date = min(forecast_date))
#min_date_novdec
```
#Fig 1:  Case truth data (no forecasts)
```{r}
p <- plot_forecasts(forecast_data = forecasts_data_unique, 
                    truth_source = "JHU",
                    target_variable = "inc case",  
                    intervals = c(.5, .8, .95),
                    facet = .~location_name,
                    facet_scales = "free_y",
                    fill_by_model = TRUE,
                    plot = FALSE) 
p +
  scale_x_date(name=NULL, date_breaks = "1 months", date_labels = "%b") +
  theme(axis.ticks.length.x = unit(0.5, "cm"),
    axis.text.x = element_text(vjust = 7, hjust = -0.2))
```
```{r}
dates_tibble <- tibble(
  location_name = c("California", "Florida", "Massachusetts", "Michigan", "New York", "Texas"),
  date = as.Date(c('2020-12-03','2020-12-17',"2020-12-08","2020-12-07","2020-12-11","2020-11-25"))
)

truth_plot <- truth_data  %>% ggplot(aes(x = target_end_date, 
             y = value, 
             color = location_name)) + 
  geom_line() +
  facet_wrap(.~location_name, scales = "free_y") +
  theme_linedraw() 


truth_plot+  labs(title = "Incident Cases Truth Data", x = "Date", y = "Incident Cases", color = "Location") + theme(axis.text.x = element_text(angle = 90)) + theme(legend.position = "none")

# geom_vline(aes(xintercept = date), dates_tibble) +
```

#Fig 2: line graph of WIS score over time  (by model)
## Note: need to figure out how to group by color
```{r}
scores  <- scored_forecasts  %>%
  dplyr::group_by(model, target_end_date) %>% 
  dplyr::summarise(wis = mean(wis)) 
scores  %>% 
  ggplot(aes(x = target_end_date, y = wis, color = model)) + geom_line() + labs(title = "WIS Score by Model", x = "Date", y = "WIS Score", color = "Model")
```

##Fig3a: Grouped by the model group
```{r}
scored_forecasts$type <- "Neither"
scored_forecasts$type[scored_forecasts$model == "CU-select" | scored_forecasts$model == "OliverWyman-Navigator" | scored_forecasts$model == "JHUAPL-Bucky"] <- "Mobility and Social Distancing/NPIs"
scored_forecasts$type[scored_forecasts$model == "IowaStateLW-STEM" | scored_forecasts$model == "UVA-Ensemble"] <- "Only Mobility"
scored_forecasts$type[scored_forecasts$model == "JHU_IDD-CovidSP"] <- "Only Social Distancing/NPIs"

scores_type <- scored_forecasts %>%
  dplyr::group_by(model, type, target_end_date, location) %>% 
  dplyr::summarise(wis = mean(wis)) 
scores_type%>% 
  ggplot(aes(x = target_end_date, y = wis, color = type)) + geom_line(aes(linetype = model)) + labs(title = "WIS Score by Type of Model", x = "Date", y = "WIS Score", color = "Model Type", linetype = "Model Name") + facet_wrap(.~location, scales = "free_y") + theme(axis.text.x = element_text(angle = 90)) 


#group and facet by horizon
scores_horizon <- scored_forecasts %>%
  dplyr::group_by(model, type, horizon) %>% 
  dplyr::summarise(wis = mean(wis)) 
scores_horizon %>% 
  ggplot(aes(x = horizon, y = wis, color = type)) + geom_point() + facet_wrap(.~horizon) + labs(title = "WIS Score by Type of Model and Horizon", x = "Horizon", y = "WIS Score", color = "Model Type", linetype = "Model Name")
```

##Fig3: Line graph faceted by location 
```{r}
scores_location <- scored_forecasts %>%
  dplyr::group_by(location, model, target_end_date) %>% 
  dplyr::summarise(wis = mean(wis)) 


score_plots <- scores_location %>% 
  ggplot(aes(x = target_end_date, y = wis, color = model)) + geom_line() + facet_wrap(.~location, scale = "free_y") + theme_linedraw()
#free y in facet
score_plots + labs(title = "WIS Scores by State and Model", x = "Date", y = "WIS Score", color = "Model") + theme(axis.text.x = element_text(angle = 90))
```

##Table1: Number of observations for each model
```{r}
num_obs <- forecasts_data_unique %>% count(model)
DT::datatable(num_obs)
```


##Table2: Average WIS scores across models 
```{r}
avg_wis <- scored_forecasts %>% group_by(model) %>% summarise(avg = mean(wis))
DT::datatable(avg_wis)
```


##Table3: Average MAE over all models (abs_error)
```{r}
avg_mae <- scored_forecasts %>% group_by(model) %>% summarise(avg = mean(abs_error))
DT::datatable(avg_mae)
```

## Heatmap
```{r}
scored_forecasts %>% filter(model != "OliverWyman-Navigator") %>% 
  dplyr::group_by(model, location) %>%
  dplyr::summarise(wis = mean(wis)) %>%
  scoringutils::score_heatmap(metric = "wis", x = "location")
```







